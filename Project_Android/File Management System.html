<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Management System</title>
    <style>

        body {
            font-family: 'Georgia', serif;
            background-color: #f4f7fc;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            width: 40%;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1 {
            	text-align: center;
            	color: #333;
            	font-size: 2rem;
            	margin-bottom: 20px;
	}
            
	h2 {
            	text-align: center;
                font-size: 1.4rem;
        }
	h3 {
            	text-align: center;
                font-size: 1.8rem;
	}

        /* Form Styling */
        form {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        label {
            font-size: 1rem;
            font-weight: 500;
        }

        input[type="text"], input[type="date"], select {
            padding: 8px;
            font-size: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: 0.3s ease;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            border-color: #5c6bc0;
            outline: none;
        }
	.button-container {
    		display: flex;
    		justify-content: center; /* Centers the button horizontally */
    		width: 100%; /* Ensures it spans the form width */
	}

        button[type="submit"] {
            padding: 8px 18px;
	    width: 40%;
            font-size: 0.9rem;
            color: #fff;
            background-color: #5c6bc0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button[type="submit"]:hover {
            background-color: #3f51b5;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #5c6bc0;
            color: #fff;
            font-weight: bold;
        }

        td {
            background-color: #fafafa;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        /* No Records Found Message */
        .no-records {
            text-align: center;
            font-size: 1.2rem;
            color: #999;
        }
	    .search-container {
    		display: flex;
    		flex-wrap: wrap;
    		justify-content: center;
    		align-items: center;
    		gap: 10px;
    		margin: 20px auto;
    		width: 90%;
    		max-width: 580px;
    		padding: 10px;
    		background: #ffffff;
    		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    		border-radius: 8px;
		box-sizing: border-box;
	    }
	    .search-container select, {
    		padding: 8px;
    		font-size: 0.9rem;
    		border: 1px solid #ddd;
    		border-radius: 5px;
    		width: auto;
    		min-width: 80px;
    		max-width: 150px;
	    }
	    .search-container input {
		flex: 1;
    		width: 100%;
    		max-width: 400px;
	    }
	    .search-container select, 
	    .search-container input {
    		flex-basis: calc(50% - 10px); /* Ensures two items per row */
	    }
        /* Responsive Design for smaller screens */
        @media (max-width: 768px) {
            .container {
                width: 90%;
            }

            table {
                font-size: 0.9rem;
            }

    </style>
</head>
<body>
    <div class="container">
    <h1><u>File Management System</u></h1>
    <h2>Enter New File Details</h2>

    <form id="file-form">
        <label for="fileName">File Name:</label>
        <input type="text" id="fileName" name="fileName" required><br>

        <label for="fileNo">File No:</label>
        <input type="text" id="fileNo" name="fileNo" required><br>

        <label for="issueDate">Issue Date:</label>
        <input type="date" id="issueDate" name="issueDate" required><br>

        <label for="dealingAssistant">Dealing Assistant:</label>
            <select id="dealingAssistant" name="dealingAssistant" required>
                <option value="" disabled selected>Select Assistant</option>
                <option value="Kutub Uddin Laskar">Kutub Uddin Laskar</option>
                <option value="Subrata Nath">Subrata Nath</option>
                <option value="Supriya Deb Nath">Supriya Deb Nath</option>
                <option value="Abhijit Biswas">Abhijit Biswas</option>
                <option value="Biswajit Deb">Biswajit Deb</option>
                <option value="Afjajul Ahmed Mazumder">Afjajul Ahmed Mazumder</option>
                <option value="Atul Jigdung">Atul Jigdung</option>
                <option value="Arnab Ghosh">Arnab Ghosh</option>
                <option value="Dibyendu Choudhury">Dibyendu Choudhury</option>
                <option value="Jadumoni Gogoi">Jadumoni Gogoi</option>
                <option value="Kalpayan Bhattacharjee">Kalpayan Bhattacharjee</option>
                <option value="Kangkanjyoti Pathak">Kangkanjyoti Pathak</option>
                <option value="Souvik Das">Souvik Das</option>
                <option value="Munna Lal Kurmi">Munna Lal Kurmi</option>
            </select><br>
        	<label for="details">Details:</label>
        	<input type="text" id="details" name="details" required><br>

	<div class="button-container">
        <button type="submit">Submit</button><br><br>
	</form>
    	</div>
	</div>

    		<div class="search-container">
        		<label for="searchCategory">Search by:</label>
        		<select id="searchCategory">
            		<option value="select">Select</option>
            		<option value="fileName">File Name</option>
            		<option value="fileNo">File No</option>
            		<option value="dealingAssistant">Dealing Assistant</option>
        	</select> <br>
        		<input type="text" id="searchInput" placeholder="Search..." onkeyup="filterTable()">
    		</div>

    <h3>Issued Files</h3>
    <table id="file-table">
        <thead>
            <tr>
                <th>File Name</th>
                <th>File No</th>
                <th>Issue Date</th>
                <th>Dealing Assistant</th>
                <th>Details</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>


<script>
	let files = []; // or var files = []; or const files = [];

    const repoOwner = "Dibyenduchoudhury";
    const repoName = "Central-Register";
    const filePath = "files.json";
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

	function showLoading() {
    		document.getElementById('loadingOverlay').style.display = 'flex';
	}

	function hideLoading() {
    		document.getElementById('loadingOverlay').style.display = 'none';
	}
    document.getElementById('file-form').addEventListener('submit', async function (event) {
        event.preventDefault();

        const fileName = document.getElementById('fileName').value;
        const fileNo = document.getElementById('fileNo').value;
        const issueDate = document.getElementById('issueDate').value;
        const dealingAssistant = document.getElementById('dealingAssistant').value;
        const details = document.getElementById('details').value;

        const newFileData = { fileName, fileNo, issueDate, dealingAssistant, details };
        
        const githubToken = "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";  // Replace with actual token
        const apiUrl = `https://api.github.com/repos/Dibyenduchoudhury/Central-Register/contents/files.json`;

        try {
            const response = await fetch(apiUrl, {
                headers: {
                    "Authorization": `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json"
                }
            });

            if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);

            const data = await response.json();
            const sha = data.sha;

            let existingFiles = JSON.parse(atob(data.content));
            existingFiles.push(newFileData);
            const updatedContent = btoa(JSON.stringify(existingFiles, null, 2));
console.log("Updated JSON Data:", JSON.stringify(files, null, 2));
console.log("Base64 Encoded Data:", btoa(JSON.stringify(files, null, 2)));

            const updateResponse = await fetch(apiUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json"
                },
                body: JSON.stringify({
                    message: "Added new file record",
                    content: updatedContent,
                    sha: sha
                })
            });

            if (!updateResponse.ok) throw new Error(`GitHub Update Error: ${updateResponse.status}`);

            alert("File data successfully saved!");
            addFileToTable(newFileData);
            this.reset();

        } catch (error) {
            console.error("Error updating GitHub file:", error);
            alert("Failed to update file. Check your connection.");
	} 
    });

    async function loadFileData() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);

            const data = await response.json();
            const decodedContent = atob(data.content).trim();
        const tableBody = document.getElementById('file-table').getElementsByTagName('tbody')[0];

        // Clear any existing rows in the table body
        tableBody.innerHTML = "";

            if (!decodedContent || decodedContent === "[]") {
                console.warn("files.json is empty!");
                document.getElementById('file-table').innerHTML += "<tr><td colspan='5'>No records found.</td></tr>";
                return;
            }

            let files = JSON.parse(decodedContent);
            files.forEach(file => addFileToTable(file));

        } catch (error) {
            console.error("Fetch Error:", error);
            alert("An error occurred while fetching file data.");
        }
    }

    function filterTable() {
        const searchCategory = document.getElementById("searchCategory").value;
        const searchText = document.getElementById("searchInput").value.toLowerCase();
        const table = document.getElementById("file-table");
        const rows = table.getElementsByTagName("tr");

        for (let i = 1; i < rows.length; i++) { // Start from index 1 to skip the header
            const cell = rows[i].getElementsByTagName("td");

            let columnIndex;
            if (searchCategory === "fileName") columnIndex = 0;
            else if (searchCategory === "fileNo") columnIndex = 1;
            else if (searchCategory === "dealingAssistant") columnIndex = 3;

            if (cell[columnIndex]) {
                const textValue = cell[columnIndex].textContent || cell[columnIndex].innerText;
                rows[i].style.display = textValue.toLowerCase().includes(searchText) ? "" : "none";
            }
        }
    }

    function addFileToTable(fileData) {
        const table = document.getElementById('file-table').getElementsByTagName('tbody')[0];
        const newRow = table.insertRow();

        newRow.insertCell(0).innerText = fileData.fileName;
        newRow.insertCell(1).innerText = fileData.fileNo;
        newRow.insertCell(2).innerText = fileData.issueDate;
        newRow.insertCell(3).innerText = fileData.dealingAssistant;
        newRow.insertCell(4).innerText = fileData.details;

        const deleteCell = newRow.insertCell(5);
        const deleteButton = document.createElement('button');
        deleteButton.innerText = 'Delete';
        deleteButton.style.backgroundColor = '#f44336';
        deleteButton.style.color = '#fff';
        deleteButton.style.padding = '5px 10px';
        deleteButton.style.border = 'none';
        deleteButton.style.cursor = 'pointer';

        deleteButton.onclick = async function() {
            if (confirm('Are you sure you want to delete this file?')) {
                await deleteFile(fileData);
                newRow.remove(); // Remove row from table
            }
        };

        deleteCell.appendChild(deleteButton);
    }

    async function deleteFile(fileData) {
        const githubToken = "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";  // Replace with actual token
        const apiUrl = `https://api.github.com/repos/Dibyenduchoudhury/Central-Register/contents/files.json`;

        try {
            const response = await fetch(apiUrl, {
                headers: {
                    "Authorization": `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json"
                }
            });

            if (!response.ok) throw new Error(`GitHub API Error: ${response.status}`);

            const data = await response.json();
            const sha = data.sha;

            let existingFiles = JSON.parse(atob(data.content));
            existingFiles = existingFiles.filter(file => file.fileName !== fileData.fileName);

            const updatedContent = btoa(JSON.stringify(existingFiles, null, 2));

            const updateResponse = await fetch(apiUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${githubToken}`,
                    "Accept": "application/vnd.github.v3+json"
                },
                body: JSON.stringify({
                    message: "Deleted a file record",
                    content: updatedContent,
                    sha: sha
                })
            });

            if (!updateResponse.ok) throw new Error(`GitHub Update Error: ${updateResponse.status}`);

            alert("File data successfully deleted!");

        } catch (error) {
            console.error("Error deleting file:", error);
            alert("Failed to delete file. Check your connection.");
        } 
    }

    window.onload = function () {

        loadFileData();
    };
</script>
</body>
</html>
